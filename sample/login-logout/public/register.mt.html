<%#
// ************************************************************
// public/register.mt.html
// ユーザー新規登録ページ
// ************************************************************
%>
<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>minto - 新規登録</title>
    <link rel="stylesheet" href="/assets/style.css">
</head>

<body>
    <div class="container">
        <div class="card login-card">
            <h1>新規ユーザー登録</h1>
            <p class="subtitle">アカウントを作成してください</p>

            <div id="error-msg" class="error-msg" style="display:none;"></div>
            <div id="success-msg" class="success-msg" style="display:none;"></div>

            <div class="form-group">
                <label for="userId">ユーザーID</label>
                <input type="text" id="userId" placeholder="英数字 3〜32文字" autocomplete="username">
            </div>
            <div class="form-group">
                <label for="name">表示名</label>
                <input type="text" id="name" placeholder="表示名 (省略可)">
            </div>
            <div class="form-group">
                <label for="password">パスワード</label>
                <input type="password" id="password" placeholder="4文字以上" autocomplete="new-password">
            </div>
            <div class="form-group">
                <label for="passwordConfirm">パスワード (確認)</label>
                <input type="password" id="passwordConfirm" placeholder="もう一度入力" autocomplete="new-password">
            </div>
            <button class="btn btn-primary" onclick="doRegister()">
                登録
            </button>

            <div class="register-link">
                アカウントをお持ちの方は
                <a href="/index">ログイン</a>
            </div>
        </div>
    </div>

    <script>
        async function doRegister() {
            var userId = document.getElementById("userId").value.trim();
            var name = document.getElementById("name").value.trim();
            var pw = document.getElementById("password").value;
            var pwc = document.getElementById("passwordConfirm").value;
            var errEl = document.getElementById("error-msg");
            var sucEl = document.getElementById("success-msg");
            errEl.style.display = "none";
            sucEl.style.display = "none";

            if (!userId || !pw) {
                errEl.textContent = "ユーザーIDとパスワードは必須です";
                errEl.style.display = "block";
                return;
            }
            if (pw !== pwc) {
                errEl.textContent = "パスワードが一致しません";
                errEl.style.display = "block";
                return;
            }
            try {
                var res = await fetch("/api/register", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        userId: userId, name: name,
                        password: pw, passwordConfirm: pwc
                    })
                });
                var data = await res.json();
                if (data.success) {
                    sucEl.textContent = data.message + " ログインページへ移動します...";
                    sucEl.style.display = "block";
                    setTimeout(function () { location.href = "/index"; }, 2000);
                } else {
                    errEl.textContent = data.message;
                    errEl.style.display = "block";
                }
            } catch (e) {
                errEl.textContent = "通信エラーが発生しました";
                errEl.style.display = "block";
            }
        }
        document.addEventListener("keydown", function (e) {
            if (e.key === "Enter") doRegister();
        });
    </script>
</body>

</html>