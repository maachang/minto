<%#
// ************************************************************
// public/index.mt.html
// ログインページ
// ************************************************************
%>
<%
    // ログイン済みならマイページへリダイレクト.
    const session = $loadLib("session.js");
    const sid = $request().cookie("minto_sid");
    const user = await session.get(sid);
    if (user != null) {
        $response().redirect("/mypage");
        return _$outString;
    }
%>
<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>minto - ログイン</title>
    <link rel="stylesheet" href="/assets/style.css">
</head>

<body>
    <div class="container">
        <div class="card login-card">
            <h1>minto Login</h1>
            <p class="subtitle">AWS Lambda 関数URL + S3</p>

            <div id="error-msg" class="error-msg" style="display:none;"></div>

            <div class="form-group">
                <label for="userId">ユーザーID</label>
                <input type="text" id="userId" placeholder="ユーザーIDを入力" autocomplete="username">
            </div>
            <div class="form-group">
                <label for="password">パスワード</label>
                <input type="password" id="password" placeholder="パスワードを入力" autocomplete="current-password">
            </div>
            <button class="btn btn-primary" onclick="doLogin()">
                ログイン
            </button>

            <div class="register-link">
                アカウントをお持ちでない方は
                <a href="/register">新規登録</a>
            </div>
        </div>
    </div>

    <script>
        async function doLogin() {
            var userId = document.getElementById("userId").value.trim();
            var password = document.getElementById("password").value;
            var errEl = document.getElementById("error-msg");
            errEl.style.display = "none";

            if (!userId || !password) {
                errEl.textContent = "ユーザーIDとパスワードを入力してください";
                errEl.style.display = "block";
                return;
            }
            try {
                var res = await fetch("/login", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ userId: userId, password: password })
                });
                var data = await res.json();
                if (data.success) {
                    location.href = "/mypage";
                } else {
                    errEl.textContent = data.message || "ログインに失敗しました";
                    errEl.style.display = "block";
                }
            } catch (e) {
                errEl.textContent = "通信エラーが発生しました";
                errEl.style.display = "block";
            }
        }
        document.addEventListener("keydown", function (e) {
            if (e.key === "Enter") doLogin();
        });
    </script>
</body>

</html>