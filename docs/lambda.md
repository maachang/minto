# AWS Lambda に llrtランタイムを利用可能な環境を構築 + minto デプロイ

このドキュメントでは、AWS Lambda上で URL Function を有効にした nodejs 環境の代わりに `LLRT (Low Latency Runtime)` ランタイムを用いた、nodejs 環境で動作する URL Function 環境を構築する + ローカル minto 実装の deploy 方法までの説明を行います。

## ① まずAWS Lambda に LLRT ランタイム実行環境を構築する

通常だと AWS Lambda => 関数 から「関数を作成」で `nodejs` の関数を作成する形となりますが、今回説明する `LLRT` 環境の AWS Lambda 関数を作成する場合は、作成方法が複雑になります。

## ② LLRT ランタイムのダウンロード

URL: https://github.com/awslabs/llrt/releases

まず上のURLリンクを押下して、以下をダウンロードします。
-  llrt-lambda-arm64-no-sdk.zip

今回作成する AWS Lambda は実行効率の良いとAWSが言ってる `arm64` 環境を対象とします。

上の zip ファイルは AWS-SDK-V3 環境が入ってないもので、最も軽量な LLRT ランタイムとなりますので、これをダウンロードします。

## ③ ダウンロードした LLRT ランタイムを AWS レイヤー登録する

次に先程ダウンロードした `LLRT ランタイム` を AWS Lambda で利用可能にするために `Lambda レイヤー登録` を行います。

1. lambda
2. レイヤー
3. レイヤーを作成

上記の流れで Lambda レイヤー作成を行います。

- 名前: llrt
- 説明 - オプション: llrt v0.5.1-beta no-sdk
- zipファイルをアップロード -> ファイルを選択(llrt-lambda-arm64-no-sdk.zip を選択)
- 互換性のあるアーキテクチャー オプション: arm64
- 互換性のあるランタイム- オプション: Amazon Linux 2023

上記の内容で登録します。

これで LLRT のレイヤー登録は完了です。

## ④ llrt 実行用の 関数を作成する

1. lambda
2. 関数
3. 関数を作成

これで AWS Lambd の関数を作成します。

- 関数名: 任意で（例: mintoTest)
- ランタイム: Amazon Linux 2023
- アーキテクチャー: arm64
- それ以外(任意)
  また `実行ロール` は別途作成したもの、デフォルトロールどちらでも構わないです。

上記の内容で作成します。

一旦これで `llrt 用の lambda 環境` の作成はできました。

次に 対象 Lambda に対して、先程の llrt レイヤーの登録を行います。

## ⑤ 作成した Lambda に LLRTレイヤーを登録する

まず対象Lambda関数のトップ表示で表示されている `Layers` をクリックして「レイヤー登録」を行います。

1. カスタムレイヤーを選択
2. カスタムレイヤ: さきほど登録したレイヤーを選択(llrt)
3. バージョン: 今回新しく登録なら「１」を選択
4. 追加ボタンを押下

これによって LLRTランタイムの起動環境が作成できました。

次より 環境設定を行い URL Function を有効して、サーバレス環境を作成します。

## ⑥ LLRT Lambdaに URL Function などの環境設定.

Lambda関数のメニュー
> `・コード ・テスト ・モニタリング ・設定 ・エイリアス ・バージョン`

ここで「設定 => 一般設定 => 編集」で 
  - 説明 - オプション： 必要な場合入れておくとわかりやすいです
  - メモリ: 128MB
  - エフェメラルストレージ: 512MB
  - タイムアウト: 15分 00秒

これを設定して `保存` を押下します。

次に「設定 => 関数URL => 関数 URL を作成」で
  - 認証タイプ: None

これを選択して `保存` を押下します。

これによって「グローバルからアクセス可能な URL が生成されるので、これを URL Function として ブラウザから利用します。

一旦これらの設定で
- 基本設定
- URL Function 有効 

の設定ができました。

## ⑦ ローカルminto でデプロイした zip をアップロードする

Lambda関数のメニュー
> `コード テスト モニタリング 設定 エイリアス バージョン`

ここで「コード => アップロード元 => zipファイル」で
- zipファイル

を選択し `ローカルminto でデプロイした zip をアップロード` します。

一旦ここまでで、ローカル minto 環境の AWS Lambda(llrt) への `デプロイ対応` は完了となります。

あとは先程の URL Function で発行されたURLを、ブラウザで読み込む事で、確認が出来ます。

## EOF

これで minto ローカル閑居内容を lambda 化することが出来ました。